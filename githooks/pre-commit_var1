#!/bin/sh

# Stellt sicher, dass das Skript im Root-Verzeichnis des Repositories ausgeführt wird.
cd "$(git rev-parse --show-toplevel)" || exit

echo "--- Führe Pre-Commit-Hook aus ---" >&2

# --- 1. Prüfung auf unerwünschte, sensible Dateien ---

# Liste der Dateien, die niemals committet werden dürfen (durch Leerzeichen getrennt)
FILES_TO_BLOCK="serviceAccountKey.json"

# Finde alle für den Commit vorgemerkten ("staged") Dateien
STAGED_FILES=$(git diff --cached --name-only)

# Variable, um zu prüfen, ob der Commit abgebrochen werden muss
BLOCK_COMMIT=false

# Gehe durch jede zu blockierende Datei
for FILE in $FILES_TO_BLOCK; do
  # Prüfe, ob die Datei committet werden soll
  if echo "$STAGED_FILES" | grep -q "^$FILE$"; then
    echo "############################################################" >&2
    echo "FEHLER: Versuch, die sensible Datei '$FILE' zu committen!" >&2
    echo "Diese Datei darf niemals in das Repository gelangen." >&2
    echo "############################################################" >&2
    BLOCK_COMMIT=true
  fi
done

# Wenn eine blockierte Datei gefunden wurde, brich den Commit sofort ab.
if [ "$BLOCK_COMMIT" = true ]; then
  echo "\nCOMMIT ABGEBROCHEN. Bitte entferne die sensible(n) Datei(en) aus dem Git-Tracking." >&2
  exit 1 # Bricht den Commit-Vorgang mit einem Fehler ab
fi

# --- 2. Sicherstellen, dass die Dummy-google-services.json committet wird ---

TARGET_FILE_PATH="app/google-services.json"

echo "-> Überschreibe '$TARGET_FILE_PATH' mit Dummy-Version für den Commit." >&2

# Erstelle die Dummy-Version der google-services.json
# Using a heredoc for multiline JSON content
cat <<EOF > "$TARGET_FILE_PATH"
{
  "project_info": {
    "project_number": "0",
    "firebase_url": "https://dummy.firebaseio.com",
    "project_id": "dummy-project",
    "storage_bucket": "dummy-project.appspot.com"
  },
  "client": [
    {
      "client_info": {
        "mobilesdk_app_id": "1:0:android:0",
        "android_client_info": {
          "package_name": "de.geosphere.speechplaning"
        }
      },
      "oauth_client": [],
      "api_key": [
        {
          "current_key": "dummy_api_key"
        }
      ],
      "services": {
        "appinvite_service": {
          "other_platform_oauth_client": []
        }
      }
    }
  ],
  "configuration_version": "1"
}
EOF

# Füge die nun überschriebene Dummy-Datei zum Commit hinzu.
# Das stellt sicher, dass immer nur die Dummy-Version im Repository landet.
git add "$TARGET_FILE_PATH"

echo "-> Commit ist sauber. Fortfahren..." >&2

# Exit 0, um den Commit zu erlauben.
exit 0
